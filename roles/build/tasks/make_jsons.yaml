# Saves components to <jsons> directory

# Arguments:
#   component_path: path to current version
#   built_components: built components

- block:
  - name: 'Create build directories: <v{{ b_version }}>'
    file:
      path: "{{ item }}"
      state: directory
    
    loop: "{{ paths }}"
    vars:
      paths:
        - "{{ component_path }}/jsons"
        - "{{ component_path }}/jsons/components"
        - "{{ component_path }}/jsons/index_templates"
        - "{{ component_path }}/jsons/ilm"
        - "{{ component_path }}/jsons/index_settings"
        - "{{ component_path }}/jsons/cluster_settings"
        - "{{ component_path }}/jsons/index_mappings"
        
  - name: 'Move components enriched with settings to jsons'
    copy:
      dest: "{{ path }}"
      content: "{{ nested | to_json }}"

    vars:
      nested:
        template: "{{ item.value }}"
      path: "{{ component_path }}/jsons/components/{{ item.key }}.json"
    with_dict: "{{ built_components }}"

  - name: 'Copy ready jsons from various components to build directory (jsons)'
    include_tasks: ready_jsons.yaml

    vars:
      folders:
        - src: "{{ component_path }}/components/*.json"
          dest: "{{ component_path }}/jsons/components"

        - src: "{{ component_path }}/index_templates/*.json"
          dest: "{{ component_path }}/jsons/index_templates"

        - src: "{{ component_path }}/ilm/*.json"
          dest: "{{ component_path }}/jsons/ilm"

        - src: "{{ component_path }}/cluster_settings/*.json"
          dest: "{{ component_path }}/jsons/cluster_settings"
        
        - src: "{{ component_path }}/index_settings/*.json"
          dest: "{{ component_path }}/jsons/index_settings"

        - src: "{{ component_path }}/index_mappings/*.json"
          dest: "{{ component_path }}/jsons/index_mappings"
    
    loop: "{{ folders }}"
    loop_control:
      loop_var: folder