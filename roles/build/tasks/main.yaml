- name: 'Initalizing task with variables'
  set_fact:
    b_version: "{{ semaphore_vars.task_details.target_version | int }}"
    component_path: "/opt/semaphore_data/builds/elastic-component-v{{ semaphore_vars.task_details.target_version }}"

- name: 'Get source code and setup runner for work'
  block:
    - name: 'Check if generic build directory exists'
      ansible.builtin.file:
        path: '/opt/semaphore_data/builds/'
        state: directory

    - name: 'Delete if component directory exists: <v{{ b_version }}>'
      ansible.builtin.file:
        path: "{{ component_path }}"
        state: absent

    - name: 'Clone the elastic-component settigns: <v{{ b_version }}>'
      ansible.builtin.git:
        repo: '{{ components_repo }}'
        dest: "{{ component_path }}"


- name: 'Load settings and components'
  include_tasks: load.yaml

- name: 'Combine settings and components'
  include_tasks: combine.yaml

- name: 'Make jsons (unpacked build)'
  include_tasks: make_jsons.yaml

- name: 'Set elastic_test_host as curr_elastic_host'
  set_fact:
    curr_elastic_host: '{{ elastic_test_host  }}'

- name: 'Test build (components part)'
  block:
    - name: 'Check configuration on test host (template components)'
      include_tasks: update_components.yaml

    - name: 'Check status and apply rollback if need'
      include_tasks: check_with_rollback.yaml

- name: 'Test build (index templates part)'
  block:
    - name: 'Check configuration on test host (index templates)'
      include_tasks: update_index_templates.yaml

    - name: 'Check status and apply rollback if need (^2)'
      include_tasks: check_with_rollback.yaml

- name: 'Test build (ilm part)'
  block:
    - name: 'Check configuration on test host (ilm)'
      include_tasks: update_ilm.yaml

    - name: 'Check status and apply rollback if need (^3)'
      include_tasks: check_with_rollback.yaml

- name: 'Mark build as good'
  file:
    path: "{{ component_path }}/.good_build"
    state: touch
  
    modification_time: preserve
    access_time: preserve