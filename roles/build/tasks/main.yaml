- name: 'Get source and setup runner for work'
  block:
    - name: 'Remove previous elastic-component settings'
      ansible.builtin.file:
        path: '/tmp/elastic-component'

        # Директория будет рекурсивно удалена
        state: absent

    - name: 'Clone new settings'
      ansible.builtin.git:
        repo: 'https://github.com/neopoleones/elastic-component'
        dest: '/tmp/elastic-component'

    - name: 'Create build directory'
      ansible.builtin.file:
        path: '/tmp/elastic-component/build'
        state: directory

# Здесь разбираемся с темплейтами компонентов
- name: 'Prepare configuration of component templates'
  block:
    - name: 'Find component templates'
      ansible.builtin.find:
        paths: /tmp/elastic-component/components
        patterns: '*.yaml,*.yml'
      register: f_components

    - name: 'Find settings'
      ansible.builtin.find:
        paths: /tmp/elastic-component/settings
        patterns: '*.yaml,*.yml'
        recurse: true 
      register: f_settings

    - name: Show settings 
      command: "cat {{ item.path }}"
      register: objs

      loop: "{{ f_settings.files }}"

    - debug:
        msg:
          - "settings: {{ obj }}"
      vars:
        obj: "{{ item.stdout | from_yaml }}"
        
      loop: "{{ objs.results }}"
      loop_control:
        label: "{{ item.item }}"